<section
  class="w-full h-screen flex bg-gray-50 dark:bg-neutral-950 transition-colors duration-300 overflow-hidden"
>
  <!-- ===== LEFT SIDEBAR (DESKTOP) ===== -->
  <aside
    class="hidden lg:flex flex-col border-r border-gray-200 dark:border-neutral-800 bg-gray-50 dark:bg-neutral-950 p-4 transition-all duration-300 ease-in-out"
    [class.w-64]="!sidebarCollapsed()"
    [class.w-20]="sidebarCollapsed()"
  >
    <!-- Top -->
    <div
      class="flex items-center justify-between"
      [class.flex-col]="sidebarCollapsed()"
    >
      <div
        class="flex items-center gap-2 overflow-hidden justify-center"
        [class.flex-col]="sidebarCollapsed()"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-8 h-8 text-indigo-600 dark:text-amber-400 flex-shrink-0"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path d="M12 2L2 7l10 5 10-5-10-5z" />
          <path d="M2 17l10 5 10-5" />
        </svg>

        @if (!sidebarCollapsed()) {
        <h1
          class="text-xl font-semibold text-gray-900 dark:text-neutral-100 truncate"
        >
          Scrappy
        </h1>
        }
      </div>

      <!-- Collapse Button -->
      <button
        type="button"
        class="mt-2 flex items-center justify-center w-9 h-9 rounded-md border border-gray-300/60 dark:border-neutral-700/60 bg-white/80 dark:bg-neutral-900/80 hover:bg-gray-100/80 dark:hover:bg-neutral-800/80 transition-all duration-300"
        (click)="toggleSidebar()"
        aria-label="Collapse sidebar"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-4 h-4 text-gray-700 dark:text-neutral-200 transition-transform duration-300"
          [class.rotate-180]="sidebarCollapsed()"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path d="M15 19l-7-7 7-7" />
        </svg>
      </button>
    </div>

    <!-- Nav Links -->
    <nav
      class="flex flex-col space-y-2 text-sm font-medium mt-6"
      [ngClass]="{
        'items-center': sidebarCollapsed(),
        'items-stretch': !sidebarCollapsed()
      }"
    >
      <a
        routerLink="/dashboard"
        class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-600 dark:text-neutral-400 hover:bg-indigo-50 dark:hover:bg-neutral-800 hover:text-indigo-600 dark:hover:text-amber-400 transition"
        [ngClass]="{ 'justify-center': sidebarCollapsed() }"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path d="M3 13h8V3H3zM13 21h8v-8h-8zM13 3h8v8h-8zM3 13h8v8H3z" />
        </svg>
        @if (!sidebarCollapsed()) { <span>Dashboard</span> }
      </a>

      <a
        routerLink="/marketplace-page"
        class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-600 dark:text-neutral-400 hover:bg-indigo-50 dark:hover:bg-neutral-800 hover:text-indigo-600 dark:hover:text-amber-400 transition"
        [ngClass]="{ 'justify-center': sidebarCollapsed() }"
      >
        <svg
          class="w-6 h-6 text-gray-800 dark:text-white"
          aria-hidden="true"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          fill="none"
          viewBox="0 0 24 24"
        >
          <path
            stroke="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 12c.263 0 .524-.06.767-.175a2 2 0 0 0 .65-.491c.186-.21.333-.46.433-.734.1-.274.15-.568.15-.864a2.4 2.4 0 0 0 .586 1.591c.375.422.884.659 1.414.659.53 0 1.04-.237 1.414-.659A2.4 2.4 0 0 0 12 9.736a2.4 2.4 0 0 0 .586 1.591c.375.422.884.659 1.414.659.53 0 1.04-.237 1.414-.659A2.4 2.4 0 0 0 16 9.736c0 .295.052.588.152.861s.248.521.434.73a2 2 0 0 0 .649.488 1.809 1.809 0 0 0 1.53 0 2.03 2.03 0 0 0 .65-.488c.185-.209.332-.457.433-.73.1-.273.152-.566.152-.861 0-.974-1.108-3.85-1.618-5.121A.983.983 0 0 0 17.466 4H6.456a.986.986 0 0 0-.93.645C5.045 5.962 4 8.905 4 9.736c.023.59.241 1.148.611 1.567.37.418.865.667 1.389.697Zm0 0c.328 0 .651-.091.94-.266A2.1 2.1 0 0 0 7.66 11h.681a2.1 2.1 0 0 0 .718.734c.29.175.613.266.942.266.328 0 .651-.091.94-.266.29-.174.537-.427.719-.734h.681a2.1 2.1 0 0 0 .719.734c.289.175.612.266.94.266.329 0 .652-.091.942-.266.29-.174.536-.427.718-.734h.681c.183.307.43.56.719.734.29.174.613.266.941.266a1.819 1.819 0 0 0 1.06-.351M6 12a1.766 1.766 0 0 1-1.163-.476M5 12v7a1 1 0 0 0 1 1h2v-5h3v5h7a1 1 0 0 0 1-1v-7m-5 3v2h2v-2h-2Z"
          />
        </svg>

        @if (!sidebarCollapsed()) { <span>Marketplace</span> }
      </a>

      <a
        routerLink="/chat-page"
        class="flex items-center gap-3 px-3 py-2 rounded-lg text-indigo-600 dark:text-amber-400 bg-indigo-50 dark:bg-neutral-800 transition"
        [ngClass]="{ 'justify-center': sidebarCollapsed() }"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" />
        </svg>
        @if (!sidebarCollapsed()) { <span>Chat</span> }
      </a>

      <a
        routerLink="/analytics"
        class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-600 dark:text-neutral-400 hover:bg-indigo-50 dark:hover:bg-neutral-800 hover:text-indigo-600 dark:hover:text-amber-400 transition"
        [ngClass]="{ 'justify-center': sidebarCollapsed() }"
      >
        <svg
          class="w-6 h-6 text-gray-800 dark:text-white"
          aria-hidden="true"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          fill="none"
          viewBox="0 0 24 24"
        >
          <path
            stroke="currentColor"
            stroke-linecap="round"
            stroke-width="1.5"
            d="M4.5 17H4a1 1 0 0 1-1-1 3 3 0 0 1 3-3h1m0-3.05A2.5 2.5 0 1 1 9 5.5M19.5 17h.5a1 1 0 0 0 1-1 3 3 0 0 0-3-3h-1m0-3.05a2.5 2.5 0 1 0-2-4.45m.5 13.5h-7a1 1 0 0 1-1-1 3 3 0 0 1 3-3h3a3 3 0 0 1 3 3 1 1 0 0 1-1 1Zm-1-9.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0Z"
          />
        </svg>

        @if (!sidebarCollapsed()) { <span>Forum</span> }
      </a>

      <a
        routerLink="/settings"
        class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-600 dark:text-neutral-400 hover:bg-indigo-50 dark:hover:bg-neutral-800 hover:text-indigo-600 dark:hover:text-amber-400 transition"
        [ngClass]="{ 'justify-center': sidebarCollapsed() }"
      >
        <svg
          class="size-4 w-6 h-6 text-gray-500 dark:text-neutral-400"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.591 1.085 1.724 1.724 0 012.376 2.376 1.724 1.724 0 001.085 2.591c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.085 2.591 1.724 1.724 0 01-2.376 2.376 1.724 1.724 0 00-2.591 1.085c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.591-1.085 1.724 1.724 0 01-2.376-2.376 1.724 1.724 0 00-1.085-2.591c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.085-2.591 1.724 1.724 0 012.376-2.376 1.724 1.724 0 002.591-1.085z"
          />
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
          />
        </svg>
        @if (!sidebarCollapsed()) { <span>Settings</span> }
      </a>

      <!-- === Dark Mode Toggle === -->
      <button
        type="button"
        (click)="toggleTheme()"
        class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-600 dark:text-neutral-400 hover:bg-indigo-50 dark:hover:bg-neutral-800 hover:text-indigo-600 dark:hover:text-amber-400 transition mt-4"
        [ngClass]="{ 'justify-center': sidebarCollapsed() }"
      >
        @if (!isDarkMode) {
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path
            d="M12 3v1m0 16v1m8.66-9h1M3.34 12h1m12.02 7.66l.7.7M5.34 5.34l.7.7m0 12.02l-.7.7m12.02-12.02l-.7.7M12 5a7 7 0 100 14 7 7 0 000-14z"
          />
        </svg>
        } @else {
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
        </svg>
        } @if (!sidebarCollapsed()) {
        <span>{{ isDarkMode ? "Light Mode" : "Dark Mode" }}</span>
        }
      </button>
    </nav>

    <!-- Chat List (desktop) -->
    <div
      class="border-t border-gray-200 dark:border-neutral-800 mt-6 pt-4 overflow-y-auto"
      [ngClass]="{ 'flex flex-col items-center': sidebarCollapsed() }"
    >
      @if (!sidebarCollapsed()) {
      <h2
        class="text-sm font-semibold text-gray-700 dark:text-neutral-300 mb-2"
      >
        Latest Chat
      </h2>
      }

      <div
        class="space-y-2 overflow-y-auto max-h-[40vh]"
        [ngClass]="{ 'space-y-4': sidebarCollapsed() }"
      >
        @if (latestChat) {
        <div
          class="flex items-center gap-3 p-2 rounded-xl cursor-pointer hover:bg-indigo-50 dark:hover:bg-neutral-800 transition"
          [ngClass]="{ 'justify-center': sidebarCollapsed() }"
          (click)="openConversation(conversations[0]._id)"
        >
          <img
            [src]="latestChat.user_profile_img || 'https://i.pravatar.cc/100'"
            class="w-8 h-8 rounded-full ring-2 ring-indigo-100 dark:ring-amber-300/40"
          />

          @if (!sidebarCollapsed()) {
          <div>
            <p class="font-medium text-gray-900 dark:text-neutral-100">
              {{ latestChat.user_first_name }} {{ latestChat.user_last_name }}
            </p>
            <p class="text-xs text-gray-500 dark:text-neutral-400">
              {{ latestChat.user_status }}
            </p>
          </div>
          }
        </div>
        }
      </div>
    </div>
  </aside>

  <!-- ===== MAIN CHAT AREA ===== -->
  <div class="flex-1 flex relative">
    <!-- MOBILE COMBINED SIDEBAR -->
    @if (mobileSidebarOpen()) {
    <aside
      class="fixed inset-y-0 left-0 z-50 w-3/4 max-w-sm bg-gray-50 dark:bg-neutral-950 border-r border-gray-200 dark:border-neutral-800 p-6 overflow-y-auto space-y-6 transition-transform duration-300 ease-in-out shadow-xl backdrop-blur-md"
    >
      <!-- Top -->
      <div class="flex items-center justify-between">
        <h1 class="text-lg font-semibold text-gray-900 dark:text-neutral-100">
          Menu
        </h1>
        <button
          type="button"
          class="flex items-center justify-center w-9 h-9 rounded-md border border-gray-300/60 dark:border-neutral-700/60 bg-white/80 dark:bg-neutral-900/80 hover:bg-gray-100/80 dark:hover:bg-neutral-800/80"
          (click)="toggleMobile()"
          aria-label="Close menu"
        >
          âœ•
        </button>
      </div>

      <!-- Combined Nav -->
      <nav class="flex flex-col space-y-2 text-sm font-medium">
        <a
          routerLink="/dashboard"
          class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-600 dark:text-neutral-400 hover:bg-indigo-50 dark:hover:bg-neutral-800 hover:text-indigo-600 dark:hover:text-amber-400 transition"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path d="M3 13h8V3H3zM13 21h8v-8h-8zM13 3h8v8h-8zM3 13h8v8H3z" />
          </svg>
          <span>Dashboard</span>
        </a>

        <a
          routerLink="/marketplace-page"
          class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-600 dark:text-neutral-400 hover:bg-indigo-50 dark:hover:bg-neutral-800 hover:text-indigo-600 dark:hover:text-amber-400 transition"
        >
          <svg
            class="w-6 h-6 text-gray-800 dark:text-white"
            aria-hidden="true"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            fill="none"
            viewBox="0 0 24 24"
          >
            <path
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 12c.263 0 .524-.06.767-.175a2 2 0 0 0 .65-.491c.186-.21.333-.46.433-.734.1-.274.15-.568.15-.864a2.4 2.4 0 0 0 .586 1.591c.375.422.884.659 1.414.659.53 0 1.04-.237 1.414-.659A2.4 2.4 0 0 0 12 9.736a2.4 2.4 0 0 0 .586 1.591c.375.422.884.659 1.414.659.53 0 1.04-.237 1.414-.659A2.4 2.4 0 0 0 16 9.736c0 .295.052.588.152.861s.248.521.434.73a2 2 0 0 0 .649.488 1.809 1.809 0 0 0 1.53 0 2.03 2.03 0 0 0 .65-.488c.185-.209.332-.457.433-.73.1-.273.152-.566.152-.861 0-.974-1.108-3.85-1.618-5.121A.983.983 0 0 0 17.466 4H6.456a.986.986 0 0 0-.93.645C5.045 5.962 4 8.905 4 9.736c.023.59.241 1.148.611 1.567.37.418.865.667 1.389.697Zm0 0c.328 0 .651-.091.94-.266A2.1 2.1 0 0 0 7.66 11h.681a2.1 2.1 0 0 0 .718.734c.29.175.613.266.942.266.328 0 .651-.091.94-.266.29-.174.537-.427.719-.734h.681a2.1 2.1 0 0 0 .719.734c.289.175.612.266.94.266.329 0 .652-.091.942-.266.29-.174.536-.427.718-.734h.681c.183.307.43.56.719.734.29.174.613.266.941.266a1.819 1.819 0 0 0 1.06-.351M6 12a1.766 1.766 0 0 1-1.163-.476M5 12v7a1 1 0 0 0 1 1h2v-5h3v5h7a1 1 0 0 0 1-1v-7m-5 3v2h2v-2h-2Z"
            />
          </svg>

          <span>Marketplace</span>
        </a>
      </nav>

      <hr class="border-gray-200 dark:border-neutral-800 my-4" />

      <!-- Chat List -->
      <div>
        <h2
          class="text-sm font-semibold text-gray-700 dark:text-neutral-300 mb-2"
        >
          Chats
        </h2>
        <div class="space-y-2 overflow-y-auto">
          @if (latestChat && conversations.length > 0) {
          <div
            class="flex items-center gap-3 p-2 rounded-xl cursor-pointer hover:bg-indigo-50 dark:hover:bg-neutral-800 transition"
            (click)="openConversation(conversations[0]._id)"
          >
            <img
              [src]="
                latestChat.user_profile_img ||
                'https://i.pravatar.cc/100?u=' + latestChat._id
              "
              class="w-8 h-8 rounded-full ring-2 ring-indigo-100 dark:ring-amber-300/40"
            />

            <div>
              <p class="font-medium text-gray-900 dark:text-neutral-100">
                {{ latestChat.user_first_name }} {{ latestChat.user_last_name }}
              </p>
              <p class="text-xs text-gray-500 dark:text-neutral-400">
                {{ latestChat.user_status || "offline" }}
              </p>
            </div>
          </div>
          } @else {
          <p class="text-gray-500 dark:text-neutral-500 text-sm p-2">
            No chats yet
          </p>
          }
        </div>
      </div>
    </aside>

    <div
      class="fixed inset-0 bg-black/40 dark:bg-black/70 z-40"
      (click)="toggleMobile()"
    ></div>
    }

    <!-- CHAT BODY -->
    <div class="flex-1 flex flex-col">
      <!-- Header -->
      <header
        class="flex items-center justify-between px-6 py-4 border-t border-b border-gray-200 dark:border-neutral-800 bg-white/80 dark:bg-neutral-900/80 backdrop-blur-md"
      >
        <div class="flex items-center gap-3">
          <!-- Mobile Toggle -->
          <button
            type="button"
            class="flex lg:hidden items-center justify-center w-10 h-10 rounded-lg border border-gray-300/60 dark:border-neutral-700/60 bg-white/80 dark:bg-neutral-900/80 backdrop-blur-sm hover:bg-gray-100/80 dark:hover:bg-neutral-800/80 transition-all duration-300"
            (click)="toggleMobile()"
            aria-label="Open menu"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-6 h-6 text-gray-800 dark:text-neutral-200"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>

          <!-- Dynamic Receiver Info -->
          @if (selectedReceiver) {
          <img
            [src]="
              selectedReceiver.user_profile_img ||
              'https://i.pravatar.cc/100?u=' + selectedReceiver._id
            "
            class="w-10 h-10 rounded-full ring-2 ring-indigo-100 dark:ring-amber-300/40"
          />

          <div>
            <p class="font-semibold text-gray-900 dark:text-neutral-100">
              {{ selectedReceiver.user_first_name }}
              {{ selectedReceiver.user_last_name }}
            </p>

            <p class="text-xs text-gray-500 dark:text-neutral-400">
              {{ selectedReceiver.user_status }}
            </p>
          </div>
          } @else {
          <!-- No conversation selected -->
          <div class="text-gray-400 dark:text-neutral-500">
            Select a conversation
          </div>
          }
        </div>
      </header>

      <!-- Messages -->
      @if (conversation_id) {
      <!-- Chat is open -->
      <main
        class="flex-1 overflow-y-auto p-6 space-y-6 bg-gray-50 dark:bg-neutral-950"
      >
        @for (m of messages; track m._id) { @if (m.sender_id._id !== myId) {
        <!-- RECEIVED -->
        <div class="flex items-start gap-3">
          <img
            [src]="
              m.sender_id.user_profile_img ||
              'https://i.pravatar.cc/100?u=' + m.sender_id._id
            "
            class="w-8 h-8 rounded-full"
          />
          <div>
            <div
              class="inline-block bg-gray-200 dark:bg-neutral-800 text-gray-900 dark:text-neutral-100 rounded-2xl px-4 py-2 text-sm"
            >
              {{ m.messages_content }}
            </div>
          </div>
        </div>
        } @else {
        <!-- SENT -->
        <div class="flex justify-end">
          <div
            class="inline-block bg-indigo-600 dark:bg-amber-400 text-white dark:text-neutral-900 rounded-2xl px-4 py-2 text-sm"
          >
            {{ m.messages_content }}
          </div>
        </div>
        } }
      </main>
      } @else {
      <!-- No conversation selected -->
      <main
        class="flex items-center justify-center text-gray-500 dark:text-neutral-400 h-full bg-gray-50 dark:bg-neutral-950"
      >
        Select a conversation to start chatting.
      </main>
      }

      <footer 
        class="relative p-4 border-t border-gray-200 dark:border-neutral-800 flex items-center gap-3 bg-white dark:bg-neutral-900"
      >
        <div class="relative flex-1">
          <button
            type="button"
            class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-neutral-300 hover:text-indigo-600 dark:hover:text-amber-400 transition"
          >
            ðŸ˜„
          </button>

          <input
            [(ngModel)]="messageContent"
            type="text"
            placeholder="Message..."
            class="w-full rounded-full p-3 pl-10 bg-gray-100 dark:bg-neutral-800 text-sm text-gray-800 dark:text-neutral-100 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            (keyup.enter)="send()"
          />
        </div>

        <button
          class="p-3 rounded-full bg-indigo-600 hover:bg-indigo-700 dark:bg-amber-400 dark:hover:bg-amber-500 transition-all"
          (click)="send()"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-6 h-6 text-white dark:text-neutral-900"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path d="M22 2L11 13"></path>
            <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
          </svg>
        </button>
      </footer>
    </div>
  </div>
</section>
